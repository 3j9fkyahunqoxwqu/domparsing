<!doctype html>
<meta charset=UTF-8>
<title>DOM Parsing and Serialization</title>
<link rel=stylesheet href=http://www.whatwg.org/style/specification>
<style>
 pre, code { font-family:monospace, sans-serif; }
 h2 code, h3 code, h4 code,
 h2 :link, h3 :link, h4 :link,
 h2 :visited, h3 :visited, h4 :visited
 { font:inherit; color:inherit; font-style:italic; }
 @media print {
   [data-anolis-spec]::after {
     content: "[" attr(data-anolis-spec) "]";
     font-size: 0.6em;
     vertical-align: super;
     text-transform: uppercase;
   }
 }
</style>
<body class=draft>
<div class=head id=head>
<h1>[TITLE]</h1>
<h2 class="no-num no-toc">Work in Progress &mdash; Last Update [DATE: 01 Jan 1901]</h2>
<dl>
 <dt>Editor
 <dd>Ms2ger &lt;ms2ger@gmail.com>

 <dt>Version history
 <dd><a href=http://bitbucket.org/ms2ger/domparser/>http://bitbucket.org/ms2ger/domparser</a>
</dl>
</div>



<h2 class="no-num no-toc">Abstract</h2>
<p>



<h2 class="no-num no-toc">Table of contents</h2>
<!--toc-->



<h2>Common infrastructure</h2>
<h3>Terminology</h3>
<p>The term <dfn>context object</dfn> means the object on which the method or
attribute being discussed was called.


<h3>Conformance requirements</h3>
<p>All diagrams, examples, and notes in this specification are
non-normative, as are all sections explicitly marked non-normative.
Everything else in this specification is normative.</p>

<p>The key words "MUST", "MUST NOT", "REQUIRED", <!--"SHALL", "SHALL
NOT",--> "SHOULD", "SHOULD NOT", "RECOMMENDED", "MAY", and
"OPTIONAL" in the normative parts of this document are to be
interpreted as described in RFC2119. For readability, these words do
not appear in all uppercase letters in this specification. <span
data-anolis-ref>RFC2119</span></p>

<p>Requirements phrased in the imperative as part of algorithms
(such as "strip any leading space characters" or "return false and
abort these steps") are to be interpreted with the meaning of the
key word ("must", "should", "may", etc) used in introducing the
algorithm.</p>

<p>Conformance requirements phrased as algorithms or specific steps
may be implemented in any manner, so long as the end result is
equivalent. (In particular, the algorithms defined in this
specification are intended to be easy to follow, and not intended to
be performant.)</p>

<p id="hardwareLimitations">User agents may impose
implementation-specific limits on otherwise unconstrained inputs,
e.g. to prevent denial of service attacks, to guard against running
out of memory, or to work around platform-specific limitations.</p>

<p>When a method or an attribute is said to call another method or attribute, the user agent must invoke its internal API for that attribute or method so that e.g. the author can't change the behavior by overriding attributes or methods with custom properties or functions in ECMAScript.

<p>Unless otherwise stated, string comparisons are done in a <span
data-anolis-spec=domcore>case-sensitive</span> manner.

<h4>Dependencies</h4>

<p>The IDL fragments in this specification must be interpreted as
required for conforming IDL fragments, as described in the Web IDL
specification. <span data-anolis-ref>WEBIDL</span>

<p>Some of the terms used in this specification are defined in <cite>DOM
Core</cite> and <cite>HTML</cite>.
<span data-anolis-ref>DOMCORE</span>
<span data-anolis-ref>HTML</span>

<h4>Extensibility</h4>

<p>Vendor-specific proprietary extensions to this specification are
strongly discouraged. Authors must not use such extensions, as
doing so reduces interoperability and fragments the user base,
allowing only users of specific user agents to access the content in
question.</p>

<p>If vendor-specific extensions are needed, the members should be
prefixed by vendor-specific strings to prevent clashes with future
versions of this specification. Extensions must be defined so that
the use of extensions neither contradicts nor causes the
non-conformance of functionality defined in the specification.</p>
<!-- thanks to QA Framework -->

<p>When vendor-neutral extensions to this specification are needed,
either this specification can be updated accordingly, or an
extension specification can be written that overrides the
requirements in this specification. When someone applying this
specification to their activities decides that they will recognise
the requirements of such an extension specification, it becomes an
<dfn title="other applicable specifications">applicable
specification</dfn> for the purposes of conformance requirements in
this specification.</p>
<!-- http://www.w3.org/mid/17E341CD-E790-422C-9F9A-69347EE01CEB@iki.fi -->



<h2>The <code>DOMParser</code> interface</h2>
<pre class=idl>interface <dfn>XMLDocument</dfn> : <span data-anolis-spec=domcore>Document</span> {
};

[Constructor]
interface <dfn>DOMParser</dfn> {
  <span data-anolis-spec=domcore>Document</span> <span title=dom-DOMParser-parseFromString>parseFromString</span>(DOMString str, DOMString contentType);
};</pre>

<p>The <dfn title=dom-DOMParser-parseFromString><code>parseFromString(<var
title>str</var>, <var title>contentType</var>)</code></dfn> method must run the
following steps:
<ol>
 <li><p>If <var title>contentType</var> isn't <code title>text/xml</code>, <code
 title>application/xml</code> or <code title>application/xhtml+xml</code>, raise
 a <code title=dom-DOMException-NOT_SUPPORTED_ERR
 data-anolis-spec=domcore>NOT_SUPPORTED_ERR</code> exception and abort these
 steps.

 <li><p>Parse <var title>str</var> with a namespace-enabled <span
 data-anolis-spec=html>XML parser</span>.

 <li>
  <p>If the previous step didn't return an error, return the newly created
  <code data-anolis-spec=domcore>Document</code>.

  <p>Otherwise, let <var title>document</var> a newly-created
  <code>XMLDocument</code> node. Append an <code
  data-anolis-spec=domcore>Element</code> node to it, with its <code
  title=dom-Node-localName data-anolis-spec=domcore>localName</code> set to
  <code title>parsererror</code> and its <code title=dom-Node-namespaceURI
  data-anolis-spec=domcore>namespaceURI</code> set to <code
  title>http://www.mozilla.org/newlayout/xml/parsererror.xml</code>. User agents
  may append nodes to this element, for example to describe the nature of the
  error.
</ol>



<h2>The <code>XMLSerializer</code> interface</h2>
<pre class=idl>[Constructor]
interface <dfn>XMLSerializer</dfn> {
  DOMString <span title=dom-XMLSerializer-serializeToString>serializeToString</span>(<span data-anolis-spec=domcore>Node</span> root);
};</pre>

<p>The
<dfn title=dom-XMLSerializer-serializeToString><code>serializeToString(<var
title>root</var>)</code></dfn> method must return the result of running the
<span data-anolis-spec=html>XML fragment serialization algorithm</span> on
<var title>root</var> (this might raise an exception instead of returning a
string).



<h2>Extensions to the <code data-anolis-spec=domcore>Element</code> interface</h2>

<pre class=idl>[Supplemental]
interface <span data-anolis-spec=domcore>Element</span> {
  attribute DOMString <span title=dom-Element-innerHTML>innerHTML</span>;
};</pre>


<h3><code title=dom-Element-innerHTML>innerHTML</code></h3>
<p>The <dfn title=dom-Element-innerHTML><code>innerHTML</code></dfn> IDL
attribute represents the markup of the
<code data-anolis-spec=domcore>Element</code>'s contents.

<dl class=domintro>
  <!--doc.ih
  <dt><var title>document</var> . <code title=dom-Document-innerHTML>innerHTML</code> [ = <var title>value</var> ]
  <dd>
    <p>Returns a fragment of HTML or XML that represents the
    <code data-anolis-spec=domcore>Document</code>.

    <p>Can be set, to replace the
    <code data-anolis-spec=domcore>Document</code>'s contents with the result of
    parsing the given string.

    <p>In the case of an <span data-anolis-spec=domcore>XML document</span>,
    will throw an
    <code data-anolis-spec=domcore title=dom-DOMException-INVALID_STATE_ERR>INVALID_STATE_ERR</code>
    if the <code data-anolis-spec=domcore>Document</code> cannot be serialized
    to XML, and a
    <code data-anolis-spec=domcore title=dom-DOMException-SYNTAX_ERR>SYNTAX_ERR</code>
    if the given string is not well-formed.
  -->

  <dt><var title>element</var> . <code title=dom-Element-innerHTML>innerHTML</code> [ = <var title>value</var> ]
  <dd>
    <p>Returns a fragment of HTML or XML that represents the element's
    contents.

    <p>Can be set, to replace the contents of the element with nodes
    parsed from the given string.

    <p>In the case of an <span data-anolis-spec=domcore>XML document</span>,
    will throw an
    <code data-anolis-spec=domcore title=dom-DOMException-INVALID_STATE_ERR>INVALID_STATE_ERR</code>
    if the <code data-anolis-spec=domcore>Element</code> cannot be serialized
    to XML, and a
    <code data-anolis-spec=domcore title=dom-DOMException-SYNTAX_ERR>SYNTAX_ERR</code>
    if the given string is not well-formed.
</dl>

<div class=impl>

<p>On getting, if the <code data-anolis-spec=domcore>Element</code>'s
<code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>
is an <span data-anolis-spec=domcore>HTML document</span>, then the attribute
must return the result of running the
<span data-anolis-spec=html>HTML fragment serialization algorithm</span> on the
<code data-anolis-spec=domcore>Element</code>; otherwise, the
<code data-anolis-spec=domcore>Element</code>'s
<code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>
is an <span data-anolis-spec=domcore>XML document</span>, and the attribute must
return the result of running the
<span data-anolis-spec=html>XML fragment serialization algorithm</span> on the
<code data-anolis-spec=domcore>Element</code> instead (this might raise an
exception instead of returning a string).

<p>On setting, the following steps must be run:

<ol>
  <li>
    <p>If the <code data-anolis-spec=domcore>Element</code>'s
    <code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>
    is an <span data-anolis-spec=domcore>HTML document</span>: Invoke the
    <span data-anolis-spec=html>HTML fragment parsing algorithm</span>.

    <p>If the <code data-anolis-spec=domcore>Element</code>'s
    <code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>
    is an <span data-anolis-spec=domcore>XML document</span>: Invoke the
    <span data-anolis-spec=html>XML fragment parsing algorithm</span>.

    <p>In either case, the algorithm must be invoked with the given value as the
    <var title>input</var>, and the <span>context object</span> as the
    <var title>context</var> element.
    <!--doc.ih
    If the node is an <code data-anolis-spec=domcore>Element</code>
    node, then, in addition, that element must be passed as the <var
    title="">context</var> element.
    -->

    <p>If this raises an exception, then abort these steps.

    <p>Otherwise, let <var title>new children</var> be the nodes returned.

  <!--doc.ih
  <li>
    <p>If the attribute is being set on a <code>Document</code> node,
    and that document has an <span>active parser</span>, then abort
    that parser.
  -->

  <li>
    <p>Remove the child nodes of the <span>context object</span>, firing
    appropriate mutation events.

  <li>
    <p>
    <!--doc.ih
    If the attribute is being set on a <code>Document</code> node,
    let <var title>target document</var> be that
    <code>Document</code> node. Otherwise, the attribute is being set
    on an <code>Element</code> node;
    -->
    Let <var title>target document</var> be the <span>context object</span>'s
    <code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>.

  <li>
    <p>Set the
    <code data-anolis-spec=domcore title=dom-Node-ownerDocument>ownerDocument</code>
    of all the <code data-anolis-spec=domcore>Node</code>s in
    <var title>new children</var> to the <var title>target document</var>.

  <li>
    <p>Append all the <var title>new children</var> nodes to the
    <span>context object</span>, preserving their order, and firing mutation
    events as if a <code data-anolis-spec=domcore>DocumentFragment</code>
    containing the <var title>new children</var> had been inserted.
</ol>

</div>



<h2 class=no-num>References</h2>
<p>All references are normative unless marked "Non-normative".</p>

<div id=anolis-references></div>



<h2 class=no-num>Acknowledgements</h2>
<p>Thanks to



for their useful comments.

<p>Special thanks to Ian Hickson for defining the
<code title=dom-Element-innerHTML>innerHTML</code> attribute in
<cite>HTML</cite>.
<span data-anolis-ref class=informative>HTML</span>

<script src="http://www.whatwg.org/specs/web-apps/current-work/dfn.js"></script>
